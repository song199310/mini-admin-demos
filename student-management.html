<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>学生信息管理</title>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>
  <nav>
    <span class="brand">Mini Admin</span>
    <a href="./index.html">首页</a>
    <a href="./student-management.html" aria-current="page">学生管理</a>
    <a href="./goods-stock.html">商品库存</a>
    <span style="margin-left:auto" class="muted" aria-hidden="true">在线演示</span>
    <button class="pri" style="margin-left: 8px;" onclick="location.hash='contact'">立即联系</button>
  </nav>

  <main class="wrap">
    <header style="margin-bottom:12px">
      <h1 style="margin:8px 0 4px">学生信息管理</h1>
      <p class="sub" style="margin:0">增删改查 · 关键词搜索 · 成绩排序 · JSON 导入导出（本地存储）</p>
    </header>

    <section class="section">
      <h2>新增 / 编辑学生</h2>
      <form id="form" class="row">
        <input id="id" type="hidden">
        <input id="name" placeholder="姓名（必填）" required />
        <input id="age" type="number" min="6" max="100" placeholder="年龄 6~100（必填）" required />
        <input id="score" type="number" min="0" max="100" placeholder="成绩 0~100（必填）" required />
        <button class="pri" type="submit">保存</button>
        <button type="button" id="resetBtn" class="ghost">重置</button>
      </form>
    </section>

    <section class="section" style="margin-top:16px">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="row" style="flex:1">
          <input id="kw" placeholder="按姓名搜索" style="flex:1;min-width:220px">
          <button id="clearKw" class="ghost">清空</button>
        </div>
        <div class="row">
          <button id="exportBtn" class="ghost">导出 JSON</button>
          <input id="importFile" type="file" accept="application/json" style="display:none">
          <button id="importBtn" class="ghost">导入 JSON</button>
          <button id="seedBtn" class="ghost">重置示例数据</button>
        </div>
      </div>
      <p class="muted" style="margin:8px 0 0">提示：点击“成绩”表头可切换升/降序。</p>

      <table>
        <thead>
          <tr>
            <th style="width:80px">ID</th>
            <th>姓名</th>
            <th class="sortable" id="thScore">成绩 ▲</th>
            <th style="width:80px">年龄</th>
            <th style="width:150px">操作</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <section id="contact" class="section contact" style="margin-top: 24px;">
      <h2>联系我</h2>
      <p class="muted">添加微信咨询项目需求（24h 内响应，支持先出样稿）</p>
      <img class="qrcode"
           src="https://raw.githubusercontent.com/song199310/mini-admin-demos/main/wechat-qrcode.jpg"
           alt="微信二维码" loading="lazy" width="180" height="180">
    </section>
  </main>

  <footer>© 2025 前端小作品集</footer>

  <script>
    const LS_KEY = 'students_v1';
    let students = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
    let sortAsc = true;

    const $ = s => document.querySelector(s);
    const $tbody = $('#tbody'), $form = $('#form');
    const $id = $('#id'), $name = $('#name'), $age = $('#age'), $score = $('#score');

    function seed(){
      students = [
        {id:1,name:'张三',age:18,score:85},
        {id:2,name:'李四',age:19,score:92},
        {id:3,name:'王五',age:17,score:73},
      ];
      save(); render();
    }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(students)); }

    function escapeHtml(str=''){return str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
    function nextId(){return students.length?Math.max(...students.map(s=>s.id))+1:1;}

    function render(){
      const kw = $('#kw').value.toLowerCase().trim();
      let list = students.filter(s=>!kw || String(s.name).toLowerCase().includes(kw));
      list = list.sort((a,b)=> sortAsc ? a.score-b.score : b.score-a.score);
      $tbody.innerHTML = list.map(s=>`
        <tr>
          <td>${s.id}</td>
          <td>${escapeHtml(s.name)}</td>
          <td>${s.score}</td>
          <td>${s.age}</td>
          <td>
            <button onclick="edit(${s.id})">编辑</button>
            <button onclick="del(${s.id})">删除</button>
          </td>
        </tr>
      `).join('') || `<tr><td colspan="5" class="muted">无数据</td></tr>`;
    }

    $form.addEventListener('submit', e=>{
      e.preventDefault();
      const data = {
        id: $id.value ? Number($id.value) : nextId(),
        name: $name.value.trim(),
        age: Number($age.value),
        score: Number($score.value)
      };
      if(!data.name) return alert('姓名必填');
      if(!(data.age>=6 && data.age<=100)) return alert('年龄需在 6~100 之间');
      if(!(data.score>=0 && data.score<=100)) return alert('成绩需在 0~100 之间');

      const idx = students.findIndex(s=>s.id===data.id);
      if(idx>-1) students[idx]=data; else students.push(data);
      save(); render();
      $form.reset(); $name.focus(); $id.value='';
    });

    window.edit = id=>{
      const s = students.find(x=>x.id===id); if(!s) return;
      $id.value=s.id; $name.value=s.name; $age.value=s.age; $score.value=s.score; $name.focus();
    };
    window.del = id=>{
      if(!confirm('确定删除该学生？')) return;
      students = students.filter(s=>s.id!==id);
      save(); render();
    };

    $('#kw').addEventListener('input', render);
    $('#clearKw').addEventListener('click', ()=>{ $('#kw').value=''; render(); });

    $('#thScore').addEventListener('click', ()=>{
      sortAsc = !sortAsc;
      $('#thScore').innerText = `成绩 ${sortAsc?'▲':'▼'}`;
      render();
    });

    $('#exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(students,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download='students.json'; a.click(); URL.revokeObjectURL(a.href);
    });

    $('#importBtn').addEventListener('click', ()=>$('#importFile').click());
    $('#importFile').addEventListener('change', e=>{
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result||'[]');
          if(!Array.isArray(data)) throw new Error('格式错误');
          const ok = data.every(s=> s && typeof s.name==='string'
            && Number.isFinite(s.age) && s.age>=6 && s.age<=100
            && Number.isFinite(s.score) && s.score>=0 && s.score<=100);
          if(!ok) throw new Error('数据不合法');
          let idBase = 1;
          students = data.map(s=>({id:idBase++,name:s.name.trim(),age:Number(s.age),score:Number(s.score)}));
          save(); render();
        }catch(err){ alert('导入失败：'+err.message); }
        e.target.value='';
      };
      reader.readAsText(f,'utf-8');
    });

    $('#seedBtn').addEventListener('click', ()=>{ if(confirm('重置为示例数据？')) seed(); });
    $('#resetBtn').addEventListener('click', ()=>{ $form.reset(); $name.focus(); });

    if(!students.length) seed(); else render();
  </script>
</body>
</html>
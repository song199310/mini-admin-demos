<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>课堂管理后台·完整版</title>
    <style>
        /*基础样式*/
        :root {
            --bg : #f6f7fb;
            --card : #fff;
            --text : #1f2937;
            --muted : #6b7280;
            --line : #e5e7eb;
            --primary : #3b82f6;
            --danger : #ef4444;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans SC", sans-serif;
            color: var(--text);
            background: var(--bg);
        }
        .app {
            max-width: 980px;
            margin: 40px auto;
            padding: 24px;
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
        }
        h1 {
            margin: 0 0 12px;
            font-size: 24px;
        }
        .sub {
            color: var(--muted);
            margin-bottom: 24px;
        }
        /*表单区*/
        form#create-form {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1fr auto;
            gap: 12px;
            align-items: end;
            margin-bottom: 16px;
        }
        label {
            display: flex;
            flex-direction: column;
            font-size: 12px;
            color: var(--muted);
        }
        input[type="text"],input[type="number"] {
            padding: 10px;
            border: 1px solid var(--line);
            border-radius: 10px;
            font-size: 14px;
            outline: none;
        }
        input[aria-invalid="true"] {
            border-color: #ef4444;
        }
        input:focus {
            border-color: var(--primary);
        }
        button {
            cursor: pointer;
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 600;
        }
        .btn-primary {
            background: var(--primary);
            color: #fff;
        }
        .btn-danger {
            background: var(--danger);
            color: #fff;
        }
        .btn-ghost {
            background: #fff;
            border: 1px solid var(--line);
        }
        /*搜索工具条*/
        .toolbar {
            display: flex;
            gap: 12px;
            align-items: center;
            margin: 8px 0 16px;
            position: relative;
        }
        .toolbar input[type="search"] {
            flex: 1;
            padding: 10px 30px 10px 12px;
            border: 1px solid var(--line);
            border-radius: 10px;
            font-size: 14px;
            outline: none;
        }
        .toolbar input[type="search"]:focus {
            border-color: var(--primary);
        }
        .toolbar .clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 2px 6px;
            color: #9ca3af;
        }
        .toolbar .clear-btn:hover {
            color: #4b5563;
        }
        /*表格*/
        .table-wrap {
            border: 1px solid var(--line);
            border-radius: 14px;
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }
        thead th {
            font-size: 12px;
            text-align: left;
            color: var(--muted);
            background: #fafafa;
            border-bottom: 1px solid var(--line);
            padding: 12px;
        }
        tbody td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--line);
            font-size: 14px;
        }
        tbody tr:hover {
            background: #fafcff;
        }
        .col-actions {
            width: 120px;
        }
        /*响应式*/
        @media (max-width : 720px) {
            form#create-form {
                grid-template-columns: 1fr 1fr;
            }
            .app {
                margin: 16px;
            }
            .table-wrap {
                overflow: auto;
            }
            table {
                min-width: 640px;
                display: block;
            }
        }
        /*轻提示*/
        .tip {
            margin: 12px 0 0;
            font-size: 12px;
            color: var(--muted);
        }
        .toast {
            position: fixed;
            inset: auto 16px 16px auto;
            background: #111;
            color: #fff;
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 13px;
            opacity: 0;
            transform: translateY(8px);
            transition: 0.25s;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="app">
        <h1>课堂管理后台 <span style="font-size: 14px; color: var(--muted);">（含搜索 + 持久化）</span></h1>
        <div class="sub">功能：显示 → 新增 → 删除 → 搜索（课程名 / 老师） → LocalStorage 持久化</div>
        <form id="create-form">
            <label>课程名
                <input type="text" id="f-title" placeholder="例如：前端加速营" required />
            </label>
            <label>
                授课老师
                <input type="text" id="f-teacher" placeholder="例如:老王" required />
            </label>
            <label>价格（元）
                <input type="number" id="f-price" placeholder="例如:299" min="0" step="1" required />
            </label>
            <button class="btn-primary" type="submit">添加课程</button>
        </form>
        <div class="tip">小技巧：先把功能跑通，不纠结样式；删除/新增后会自动保存并刷新表格。</div>
        <div class="toolbar">
            <input type="search" id="search" placeholder="搜索课程名或老师， 例如:JavaScript / Max" />
            <button id="clearSearch" class="clear-btn" aria-label="清空搜索">x</button>
        </div>
        <div class="table-wrap" style="margin-top: 16px;">
            <table>
                <thead>
                    <tr>
                        <th scope="col" style="width: 64px;">#</th>
                        <th scope="col">课程名</th>
                        <th scope="col" style="width: 160px;">老师</th>
                        <th scope="col" style="width: 140px;">价格（￥）</th>
                        <th scope="col" class="col-actions">操作</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        <div style="margin-top: 10px;">
            <button id="resetData" class="btn-ghost">重置数据（清空本地并还原示例）</button>
        </div>
        <div class="tip">后续 Day6 将做:样式升级与移动端优化;Day7:上线到 GitHub Pages。</div>
    </div>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
    <script>
        const STORAGE_KEY = 'cm:courses:v1';
        const LEGACY_KEY = 'courses';
        let courses = [
                { id: crypto.randomUUID(), title: "HTML+CSS基础", teacher: "Lynn", price: 99 },
                { id: crypto.randomUUID(), title: "JavaScript 入门", teacher: "Max", price: 199 },
                { id: crypto.randomUUID(), title: "前端项目实战", teacher: "K", price: 299 }
            ];
            try {
                let saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) {
                    const legacy = localStorage.getItem(LEGACY_KEY);
                    if (legacy) {
                        localStorage.setItem(STORAGE_KEY, legacy);
                        localStorage.removeItem(LEGACY_KEY);
                        saved = legacy;
                    }
                }
                if (saved) {
                    const arr = JSON.parse(saved);
                    if (Array.isArray(arr)) courses = arr;
                }
            } catch (err) {/* 忽略解析错误，使用默认数据 */}


        const $tbody = document.getElementById('tbody');
        const $form = document.getElementById('create-form');
        const $fTitle = document.getElementById('f-title');
        const $fTeacher = document.getElementById('f-teacher');
        const $fPrice = document.getElementById('f-price');
        const $toast = document.getElementById('toast');
        const $search = document.getElementById('search');
        const $clear = document.getElementById('clearSearch');
        const $resetBtn = document.getElementById('resetData');

        function toast (msg) {
            $toast.textContent = msg;
            $toast.classList.add('show');
            setTimeout(()=> $toast.classList.remove('show'), 1600);
        }
        function debounce (fn, delay = 200) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(()=>fn(...args), delay);
            };
        }
        function escapeHTML(str){
            return String(str).replace( /[&<>\"']/g, s=>({
                "&":"&amp;",
                "<":"&lt;",
                ">":"&gt;",
                "\"":"&quot;",
                "'":"&#39;"
            }[s]));}
        let keyword = '';
        function getFiltered() {
            const kw = keyword.trim().toLowerCase();
            if (!kw) return courses;
            return courses.filter (c => 
                String(c.title || '').toLowerCase().includes(kw) ||
                String(c.teacher || '').toLowerCase().includes(kw)
            );
        }
        function rerender() {
            renderTable(getFiltered());
        }
        function persist() {
            try {
                const clean = courses.map(c => ({
                    id: String(c.id),
                    title: String(c.title || '').trim(),
                    teacher: String(c.teacher || '').trim(),
                    price: Number(c.price || 0)
                }));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(clean));
            } catch (e) {}
        }
        function renderTable(list){
            if(!Array.isArray(list)) list = [];
            if(list.length === 0){
                $tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:20px">暂无课程</td></tr>`;
                return;
            }
            $tbody.innerHTML = list.map((item, idx)=>{
                const price = Number(item.price || 0);
                return `
                    <tr>
                        <td>${idx+1}</td>
                        <td>${escapeHTML(item.title)}</td>
                        <td>${escapeHTML(item.teacher)}</td>
                        <td>${price.toLocaleString('zh-CN')}</td>
                        <td>
                            <button class="btn-ghost" data-action="del" data-id="${item.id}" aria-label="删除: ${escapeHTML(item.title)}">删除</button>
                        </td>
                    </tr>`;
            }).join('')
        }
        $tbody.addEventListener('click', (e)=>{
            const btn = e.target.closest('button[data-action="del"]');
            if(!btn) return;
            const id = btn.dataset.id;
            const index = courses.findIndex(c => c.id === id);
            if (index > -1) {
                if (!confirm('确认删除这条课程吗?')) return;
                courses.splice(index, 1);
                persist();
                rerender();
                toast('已删除')
            }
        });
        $form.addEventListener('submit', (e)=>{
            e.preventDefault();
            const title = $fTitle.value.trim().replace(/\s+/g, ' ');
            const teacher = $fTeacher.value.trim().replace(/\s+/g, ' ');
            const priceRaw = $fPrice.value.trim();
            const price = Number(priceRaw)

            $fTitle.removeAttribute('aria-invalid');
            $fTeacher.removeAttribute('aria-invalid');
            $fPrice.removeAttribute('aria-invalid');
            
            let ok = true;
            if (title.length < 2 || title.length > 50) {
                $fTitle.setAttribute('aria-invalid', 'true');
                ok = false;
            }
            if (teacher.length  < 2 || teacher.length > 50) {
                $fTeacher.setAttribute('aria-invalid', 'true');
                ok = false;
            }
            if (!Number.isFinite(price) || price < 0 ) {
                $fPrice.setAttribute('aria-invalid', 'true');
                ok = false;
            }
            if (!ok) {
                ($fTitle.getAttribute('aria-invalid') === 'true' && $fTitle.focus()) ||
                ($fTeacher.getAttribute('aria-invalid') === 'true' && $fTeacher.focus()) ||
                $fPrice.focus();
                toast ('请检查表单：长度 2~50，价格需为非负数字');
                return;
            }
            courses.push({ id: crypto.randomUUID(), title, teacher, price });
            $form.reset();
            persist();
            rerender();
            toast('已添加');
        });

        if ($search) {
            const onSearchInput = debounce((e)=>{
                keyword = (e.target.value || '').trim();
                rerender();
            }, 200);
            $search.addEventListener('input', onSearchInput);
        }
        if ($clear) {
            $clear.addEventListener('click', () => {
                if (!$search) return;
                $search.value = '';
                keyword = '';
                rerender();
                $search.focus();
            });
        }
        if ($resetBtn) {
            $resetBtn.addEventListener('click', () => {
                if (!confirm('将清空本地数据并还原示例，确认吗？')) return;
                localStorage.removeItem(STORAGE_KEY);
                courses = [
                    { id: crypto.randomUUID(), title: "HTML+CSS 基础", teacher: "Lynn", price: 99 },
                    { id: crypto.randomUUID(), title: "JavaScript 入门", teacher: "Max",  price: 199 },
                    { id: crypto.randomUUID(), title: "前端项目实战",   teacher: "K",    price: 299 },
                ];
                persist();
                rerender();
                toast('已还原示例数据');
            });
        }
        rerender();
    </script>
</body>
</html>
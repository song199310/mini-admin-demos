<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>商品库存管理</title>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>
  <nav>
    <span class="brand">Mini Admin</span>
    <a href="./index.html">首页</a>
    <a href="./student-management.html">学生管理</a>
    <a href="./goods-stock.html" aria-current="page">商品库存</a>
    <span style="margin-left:auto" class="muted" aria-hidden="true">在线演示</span>
    <button class="pri" style="margin-left: 8px;" onclick="location.hash='contact'">立即联系</button>
  </nav>

  <main class="wrap">
    <header style="margin-bottom:12px">
      <h1 style="margin:8px 0 4px">商品库存管理</h1>
      <p class="sub" style="margin:0">增删改查 · 名称搜索 · 价格排序 · 低库存高亮 · JSON 导入导出（本地存储）</p>
    </header>

    <section class="section">
      <h2>新增 / 编辑商品</h2>
      <form id="form" class="row">
        <input id="id" type="hidden">
        <input id="title" placeholder="名称（必填）" required />
        <input id="price" type="number" min="0" step="0.01" placeholder="价格（≥0）" required />
        <input id="stock" type="number" min="0" step="1" placeholder="库存（≥0 的整数）" required />
        <button class="pri" type="submit">保存</button>
        <button type="button" id="resetBtn" class="ghost">重置</button>
      </form>
    </section>

    <section class="section" style="margin-top:16px">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="row" style="flex:1">
          <input id="kw" placeholder="按名称搜索" style="flex:1;min-width:220px">
          <button id="clearKw" class="ghost">清空</button>
        </div>
        <div class="row">
          <button id="exportBtn" class="ghost">导出 JSON</button>
          <input id="importFile" type="file" accept="application/json" style="display:none">
          <button id="importBtn" class="ghost">导入 JSON</button>
          <button id="seedBtn" class="ghost">重置示例数据</button>
        </div>
      </div>
      <p class="muted" style="margin:8px 0 0">提示：点击“价格”表头可切换升/降序；阈值可在顶部常量修改。</p>

      <table>
        <thead>
          <tr>
            <th style="width:80px">ID</th>
            <th>名称</th>
            <th class="sortable" id="thPrice">价格 ▲</th>
            <th style="width:120px">库存</th>
            <th style="width:160px">状态</th>
            <th style="width:150px">操作</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <section id="contact" class="section contact" style="margin-top: 24px;">
      <h2>联系我</h2>
      <p class="muted">添加微信咨询项目需求（24h 内响应，支持先出样稿）</p>
      <img class="qrcode"
           src="https://raw.githubusercontent.com/song199310/mini-admin-demos/main/wechat-qrcode.jpg"
           alt="微信二维码" loading="lazy" width="180" height="180">
    </section>
  </main>

  <footer>© 2025 前端小作品集</footer>

  <script>
    const LOW_STOCK_THRESHOLD = 5; // 低库存阈值：小于该值标红

    const LS_KEY = 'products_v1';
    let products = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
    let priceAsc = true;

    const $ = s => document.querySelector(s);
    const $tbody = $('#tbody'), $form = $('#form');
    const $id = $('#id'), $title = $('#title'), $price = $('#price'), $stock = $('#stock');

    function seed(){
      products = [
        {id:1,title:'苹果',price:5.2,stock:20},
        {id:2,title:'可乐',price:3.5,stock:4},
        {id:3,title:'面包',price:4.0,stock:10},
      ];
      save(); render();
    }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(products)); }

    function escapeHtml(str=''){return str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
    function nextId(){return products.length?Math.max(...products.map(p=>p.id))+1:1;}

    function render(){
      const kw = $('#kw').value.toLowerCase().trim();
      let list = products.filter(p=>!kw || String(p.title).toLowerCase().includes(kw));
      list = list.sort((a,b)=> priceAsc ? a.price-b.price : b.price-a.price);

      $tbody.innerHTML = list.map(p=>{
        const low = Number(p.stock||0) < LOW_STOCK_THRESHOLD;
        return `
          <tr>
            <td>${p.id}</td>
            <td>${escapeHtml(p.title)}</td>
            <td>￥${Number(p.price).toFixed(2)}</td>
            <td>${p.stock}</td>
            <td><span class="badge ${low?'low':''}">${low?'低库存':'正常'}</span></td>
            <td>
              <button onclick="edit(${p.id})">编辑</button>
              <button onclick="del(${p.id})">删除</button>
            </td>
          </tr>
        `;
      }).join('') || `<tr><td colspan="6" class="muted">无数据</td></tr>`;
    }

    $form.addEventListener('submit', e=>{
      e.preventDefault();
      const data = {
        id: $id.value ? Number($id.value) : nextId(),
        title: $title.value.trim(),
        price: Number($price.value),
        stock: Number($stock.value)
      };
      if(!data.title) return alert('名称必填');
      if(!(data.price>=0)) return alert('价格需≥0');
      if(!(Number.isInteger(data.stock) && data.stock>=0)) return alert('库存需为≥0的整数');

      const idx = products.findIndex(p=>p.id===data.id);
      if(idx>-1) products[idx]=data; else products.push(data);
      save(); render();
      $form.reset(); $title.focus(); $id.value='';
    });

    window.edit = id=>{
      const p = products.find(x=>x.id===id); if(!p) return;
      $id.value=p.id; $title.value=p.title; $price.value=p.price; $stock.value=p.stock; $title.focus();
    };
    window.del = id=>{
      if(!confirm('确定删除该商品？')) return;
      products = products.filter(p=>p.id!==id);
      save(); render();
    };

    $('#kw').addEventListener('input', render);
    $('#clearKw').addEventListener('click', ()=>{ $('#kw').value=''; render(); });

    $('#thPrice').addEventListener('click', ()=>{
      priceAsc = !priceAsc;
      $('#thPrice').innerText = `价格 ${priceAsc?'▲':'▼'}`;
      render();
    });

    $('#exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(products,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download='products.json'; a.click(); URL.revokeObjectURL(a.href);
    });

    $('#importBtn').addEventListener('click', ()=>$('#importFile').click());
    $('#importFile').addEventListener('change', e=>{
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result||'[]');
          if(!Array.isArray(data)) throw new Error('格式错误');
          const ok = data.every(p=> p && typeof p.title==='string'
            && Number.isFinite(Number(p.price)) && Number(p.price)>=0
            && Number.isInteger(Number(p.stock)) && Number(p.stock)>=0);
          if(!ok) throw new Error('数据不合法');
          let idBase = 1;
          products = data.map(p=>({id:idBase++,title:p.title.trim(),price:Number(p.price),stock:Number(p.stock)}));
          save(); render();
        }catch(err){ alert('导入失败：'+err.message); }
        e.target.value='';
      };
      reader.readAsText(f,'utf-8');
    });

    $('#seedBtn').addEventListener('click', ()=>{ if(confirm('重置为示例数据？')) seed(); });
    $('#resetBtn').addEventListener('click', ()=>{ $form.reset(); $title.focus(); });

    if(!products.length) seed(); else render();
  </script>
</body>
</html>